<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip Itinerary</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #0b1020; color: #f5f6fa; }
    header { background: #111731; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 1.2rem; }
    .wrap { padding: 1rem; }
    h2 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #2a3561; padding-bottom: 0.25rem; }
    .card { background: #1a2142; padding: 1rem; border-radius: 12px; margin-bottom: 0.75rem; border: 1px solid #2a3561; position: relative; }
    .time { font-weight: bold; font-size: 1rem; }
    .title { font-size: 1.1rem; font-weight: bold; margin-top: 0.25rem; }
    .details { margin-top: 0.5rem; font-size: 0.9rem; }
    .detail-row { margin-bottom: 0.25rem; }
    .detail-label { color: #9fb1d8; font-weight: 600; margin-right: 0.5rem; }
    .empty { padding: 1rem; border: 1px dashed #2a3561; border-radius: 12px; text-align: center; color: #9fb1d8; }
    .current { border: 2px solid #4a90e2; box-shadow: 0 0 8px #4a90e2; }
    .checkbox { position: absolute; top: 0.75rem; right: 0.75rem; }
    input[type="checkbox"] { transform: scale(1.3); }
  </style>
</head>
<body>
  <header>
    <h1>Trip Itinerary</h1>
  </header>
  <div class="wrap" id="list"></div>
  <script>
    let grouped = new Map();
    let allDates = [];
    let events = [];

    function parseDateDMY(dateStr) {
      if(!dateStr) return null;
      const [d,m,y] = dateStr.split("/").map(x=>parseInt(x,10));
      if(!d||!m||!y) return null;
      return new Date(y, m-1, d);
    }
    function formatDateDDMMYY(d) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}-${mm}-${yy}`;
    }

    function csvToRows(text) {
      const lines = text.trim().split(/\r?\n/);
      return lines.map(line => line.split(","));
    }

    function parseEventsFromCustomCSV(rows) {
      const header = rows[0];
      const evts = [];
      for(let i=1;i<rows.length;i++) {
        const r = rows[i];
        if(!r[0]) continue;
        const dt = parseDateDMY(r[0].trim());
        if(!dt) continue;
        const dateStr = formatDateDDMMYY(dt);
        const dep = r[5]||"";
        const arr = r[6]||"";
        const from = r[2]||"";
        const to = r[3]||"";
        const activity = from && to ? `${from} â†’ ${to}` : (from||to||"Activity");
        const details = {};
        header.forEach((col, idx) => {
          if(r[idx] && col) details[col] = r[idx];
        });
        evts.push({date:dateStr,time:dep||arr||"",activity,details,id:`${dateStr}-${i}`});
      }
      return evts;
    }

    function groupByDate(events){
      const map = new Map();
      for(const e of events){
        if(!map.has(e.date)) map.set(e.date, []);
        map.get(e.date).push(e);
      }
      return map;
    }

    function isNowOrNext(evt){
      if(!evt.time) return false;
      const [hh,mm] = evt.time.split(":").map(x=>parseInt(x,10));
      if(isNaN(hh)) return false;
      const now = new Date();
      const evtDate = new Date(parseInt("20"+evt.date.split("-")[2]), parseInt(evt.date.split("-")[1])-1, parseInt(evt.date.split("-")[0]), hh, mm||0);
      const diff = evtDate - now;
      return diff >= 0 && diff < 2*60*60*1000; // highlight if now or within next 2h
    }

    function renderAll(){
      const list = document.getElementById('list');
      list.innerHTML = '';
      const doneIds = JSON.parse(localStorage.getItem('doneIds')||'[]');
      for(const dateStr of allDates){
        const evts = grouped.get(dateStr)||[];
        const remaining = evts.filter(e=>!doneIds.includes(e.id));
        if(!remaining.length) continue;
        const h2 = document.createElement('h2');
        h2.textContent = dateStr;
        list.appendChild(h2);
        for(const e of remaining){
          const card = document.createElement('div'); card.className='card';
          if(isNowOrNext(e)) card.classList.add('current');
          const t = document.createElement('div'); t.className='time'; t.textContent = e.time || 'All day';
          const title = document.createElement('div'); title.className='title'; title.textContent = e.activity;
          const detailsDiv = document.createElement('div'); detailsDiv.className='details';
          for(const [k,v] of Object.entries(e.details)){
            const row = document.createElement('div'); row.className='detail-row';
            row.innerHTML = `<span class="detail-label">${k}:</span> ${v}`;
            detailsDiv.appendChild(row);
          }
          const cb = document.createElement('input');
          cb.type = 'checkbox'; cb.className = 'checkbox';
          cb.onchange = ()=>{
            const ids = JSON.parse(localStorage.getItem('doneIds')||'[]');
            if(cb.checked && !ids.includes(e.id)) ids.push(e.id);
            localStorage.setItem('doneIds', JSON.stringify(ids));
            renderAll();
          };
          card.appendChild(cb);
          card.appendChild(t); card.appendChild(title); card.appendChild(detailsDiv);
          list.appendChild(card);
        }
      }
    }

    async function init(){
      const res = await fetch('Itinerary.csv');
      const txt = await res.text();
      events = parseEventsFromCustomCSV(csvToRows(txt));
      grouped = groupByDate(events);
      allDates = Array.from(grouped.keys());
      allDates.sort((a,b)=>{
        const [da,ma,ya] = a.split('-').map(x=>parseInt(x));
        const [db,mb,yb] = b.split('-').map(x=>parseInt(x));
        return new Date(2000+ya,ma-1,da) - new Date(2000+yb,mb-1,db);
      });
      renderAll();
    }

    init();
  </script>
</body>
</html>
