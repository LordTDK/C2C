<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trip Itinerary</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; background: #0b1020; color: #f5f6fa; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: #111731; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 10; }
        h1 { margin: 0; font-size: 1.2rem; }
        .wrap { padding: 1rem; flex-grow: 1; }
        h2 { font-size: 1.1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #2a3561; padding-bottom: 0.25rem; }
        .card { background: #1a2142; padding: 1rem; border-radius: 12px; margin-bottom: 0.75rem; border: 1px solid #2a3561; position: relative; }
        .time { font-weight: bold; font-size: 1rem; }
        .title { font-size: 1.1rem; font-weight: bold; margin-top: 0.25rem; }
        .details { margin-top: 0.5rem; font-size: 0.9rem; }
        .detail-row { margin-bottom: 0.25rem; }
        .detail-label { color: #9fb1d8; font-weight: 600; margin-right: 0.5rem; }
        .empty { padding: 1rem; border: 1px dashed #2a3561; border-radius: 12px; text-align: center; color: #9fb1d8; }
        .current { border: 2px solid #4a90e2; box-shadow: 0 0 8px #4a90e2; }
        .checkbox { position: absolute; top: 0.75rem; right: 0.75rem; }
        input[type="checkbox"] { transform: scale(1.3); }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #111731;
            position: sticky;
            bottom: 0;
            z-index: 9;
            border-top: 1px solid #2a3561;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
        }
        .nav-button {
            background: #2a3561;
            color: #f5f6fa;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .date-display {
            font-size: 1.1rem;
            font-weight: bold;
            flex-grow: 1;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>Trip Itinerary</h1>
    </header>
    <div class="wrap" id="list"></div>
    <div class="navigation">
        <button id="prevBtn" class="nav-button">‚¨ÖÔ∏è Previous</button>
        <span id="dateDisplay" class="date-display"></span>
        <button id="todayBtn" class="nav-button">Today</button>
        <button id="nextBtn" class="nav-button">Next ‚û°Ô∏è</button>
    </div>
    <script>
        let grouped = new Map();
        let allDates = [];
        let events = [];
        let currentIndex = 0;

        function parseDateDMY(dateStr) {
            if (!dateStr) return null;
            const [d, m, y] = dateStr.split("/").map(x => parseInt(x, 10));
            if (!d || !m || !y) return null;
            return new Date(y, m - 1, d);
        }

        function formatDateDDMMYY(d) {
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yy = String(d.getFullYear()).slice(-2);
            return `${dd}-${mm}-${yy}`;
        }
        
        function formatDateForDisplay(dStr) {
            const [dd, mm, yy] = dStr.split('-');
            const date = new Date(`20${yy}`, mm - 1, dd);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function csvToRows(text) {
            const lines = text.trim().split(/\r?\n/);
            return lines.map(line => line.split(","));
        }

        function parseEventsFromCustomCSV(rows) {
            const header = rows[0];
            const evts = [];
            for (let i = 1; i < rows.length; i++) {
                const r = rows[i];
                if (!r[0]) continue;
                const dt = parseDateDMY(r[0].trim());
                if (!dt) continue;
                const dateStr = formatDateDDMMYY(dt);
                const dep = r[5] || "";
                const arr = r[6] || "";
                const from = r[2] || "";
                const to = r[3] || "";
                const activity = from && to ? `${from} ‚Üí ${to}` : (from || to || "Activity");
                
                const details = {};
                if (from) details['From'] = from;
                if (to) details['To'] = to;
                if (dep) details['Departure Time'] = dep;
                if (arr) details['Arrival Time'] = arr;
                
                evts.push({ date: dateStr, time: dep || arr || "", activity, details, id: `${dateStr}-${i}` });
            }
            return evts;
        }

        function groupByDate(events) {
            const map = new Map();
            for (const e of events) {
                if (!map.has(e.date)) map.set(e.date, []);
                map.get(e.date).push(e);
            }
            return map;
        }

        function isNowOrNext(evt) {
            if (!evt.time) return false;
            const [hh, mm] = evt.time.split(":").map(x => parseInt(x, 10));
            if (isNaN(hh)) return false;
            const now = new Date();
            const [dd, mmDate, yy] = evt.date.split('-').map(x => parseInt(x, 10));
            const evtDate = new Date(2000 + yy, mmDate - 1, dd, hh, mm || 0);
            const diff = evtDate - now;
            return diff >= 0 && diff < 2 * 60 * 60 * 1000;
        }

        function renderDay(dateStr) {
            const list = document.getElementById('list');
            list.innerHTML = '';
            
            const evts = grouped.get(dateStr) || [];
            if (evts.length === 0) {
                list.innerHTML = `<div class="empty">No events scheduled for this day.</div>`;
                return;
            }

            const doneIds = JSON.parse(localStorage.getItem('doneIds') || '[]');
            const remaining = evts.filter(e => !doneIds.includes(e.id));
            
            if (remaining.length === 0) {
                list.innerHTML = `<div class="empty">All events for this day are complete! üéâ</div>`;
                return;
            }

            for (const e of remaining) {
                const card = document.createElement('div');
                card.className = 'card';
                if (isNowOrNext(e)) card.classList.add('current');

                const t = document.createElement('div');
                t.className = 'time';
                t.textContent = e.time || 'All day';

                const title = document.createElement('div');
                title.className = 'title';
                title.textContent = e.activity;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'details';

                if(e.details['From']) {
                    const fromRow = document.createElement('div'); fromRow.className = 'detail-row';
                    fromRow.innerHTML = `<span class="detail-label">From:</span> ${e.details['From']}`;
                    detailsDiv.appendChild(fromRow);
                }
                if(e.details['To']) {
                    const toRow = document.createElement('div'); toRow.className = 'detail-row';
                    toRow.innerHTML = `<span class="detail-label">To:</span> ${e.details['To']}`;
                    detailsDiv.appendChild(toRow);
                }
                if(e.details['Departure Time']) {
                    const depRow = document.createElement('div'); depRow.className = 'detail-row';
                    depRow.innerHTML = `<span class="detail-label">Departure:</span> ${e.details['Departure Time']}`;
                    detailsDiv.appendChild(depRow);
                }
                if(e.details['Arrival Time']) {
                    const arrRow = document.createElement('div'); arrRow.className = 'detail-row';
                    arrRow.innerHTML = `<span class="detail-label">Arrival:</span> ${e.details['Arrival Time']}`;
                    detailsDiv.appendChild(arrRow);
                }

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.className = 'checkbox';
                cb.onchange = () => {
                    const ids = JSON.parse(localStorage.getItem('doneIds') || '[]');
                    if (cb.checked && !ids.includes(e.id)) ids.push(e.id);
                    localStorage.setItem('doneIds', JSON.stringify(ids));
                    renderDay(dateStr);
                };
                card.appendChild(cb);
                card.appendChild(t);
                card.appendChild(title);
                card.appendChild(detailsDiv);
                list.appendChild(card);
            }
        }

        function updateUI() {
            const dateStr = allDates[currentIndex];
            document.getElementById('dateDisplay').textContent = formatDateForDisplay(dateStr);
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === allDates.length - 1;
            renderDay(dateStr);
        }

        function findTodayIndex() {
            const today = new Date();
            const todayFormatted = formatDateDDMMYY(today);
            return allDates.indexOf(todayFormatted);
        }

        async function init() {
            const res = await fetch('Itinerary.csv');
            const txt = await res.text();
            events = parseEventsFromCustomCSV(csvToRows(txt));
            grouped = groupByDate(events);
            allDates = Array.from(grouped.keys());
            allDates.sort((a, b) => {
                const [da, ma, ya] = a.split('-').map(x => parseInt(x));
                const [db, mb, yb] = b.split('-').map(x => parseInt(x));
                return new Date(2000 + ya, ma - 1, da) - new Date(2000 + yb, mb - 1, db);
            });

            currentIndex = findTodayIndex();
            if(currentIndex === -1) currentIndex = 0;

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateUI();
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentIndex < allDates.length - 1) {
                    currentIndex++;
                    updateUI();
                }
            });

            document.getElementById('todayBtn').addEventListener('click', () => {
                const todayIndex = findTodayIndex();
                if (todayIndex !== -1) {
                    currentIndex = todayIndex;
                    updateUI();
                }
            });

            updateUI();
        }

        init();
    </script>
</body>
</html>
